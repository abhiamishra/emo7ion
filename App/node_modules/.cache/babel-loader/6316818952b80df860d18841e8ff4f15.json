{"ast":null,"code":"import * as tf from '@tensorflow/tfjs-core';\nimport { BoundingBox, Point } from '../classes';\nimport { nonMaxSuppression } from '../ops';\nimport { CELL_SIZE, CELL_STRIDE } from './config';\nimport { getSizesForScale } from './getSizesForScale';\nimport { MtcnnBox } from './MtcnnBox';\nimport { normalize } from './normalize';\nimport { PNet } from './PNet';\n\nfunction rescaleAndNormalize(x, scale) {\n  return tf.tidy(function () {\n    var _a = getSizesForScale(scale, x.shape.slice(1)),\n        height = _a.height,\n        width = _a.width;\n\n    var resized = tf.image.resizeBilinear(x, [height, width]);\n    var normalized = normalize(resized);\n    return tf.transpose(normalized, [0, 2, 1, 3]);\n  });\n}\n\nfunction extractBoundingBoxes(scoresTensor, regionsTensor, scale, scoreThreshold) {\n  // TODO: fix this!, maybe better to use tf.gather here\n  var indices = [];\n  var scoresData = scoresTensor.arraySync();\n\n  for (var y = 0; y < scoresTensor.shape[0]; y++) {\n    for (var x = 0; x < scoresTensor.shape[1]; x++) {\n      if (scoresData[y][x] >= scoreThreshold) {\n        indices.push(new Point(x, y));\n      }\n    }\n  }\n\n  var boundingBoxes = indices.map(function (idx) {\n    var cell = new BoundingBox(Math.round((idx.y * CELL_STRIDE + 1) / scale), Math.round((idx.x * CELL_STRIDE + 1) / scale), Math.round((idx.y * CELL_STRIDE + CELL_SIZE) / scale), Math.round((idx.x * CELL_STRIDE + CELL_SIZE) / scale));\n    var score = scoresData[idx.y][idx.x];\n    var regionsData = regionsTensor.arraySync();\n    var region = new MtcnnBox(regionsData[idx.y][idx.x][0], regionsData[idx.y][idx.x][1], regionsData[idx.y][idx.x][2], regionsData[idx.y][idx.x][3]);\n    return {\n      cell: cell,\n      score: score,\n      region: region\n    };\n  });\n  return boundingBoxes;\n}\n\nexport function stage1(imgTensor, scales, scoreThreshold, params, stats) {\n  stats.stage1 = [];\n  var pnetOutputs = scales.map(function (scale) {\n    return tf.tidy(function () {\n      var statsForScale = {\n        scale: scale\n      };\n      var resized = rescaleAndNormalize(imgTensor, scale);\n      var ts = Date.now();\n\n      var _a = PNet(resized, params),\n          prob = _a.prob,\n          regions = _a.regions;\n\n      statsForScale.pnet = Date.now() - ts;\n      var scoresTensor = tf.unstack(tf.unstack(prob, 3)[1])[0];\n      var regionsTensor = tf.unstack(regions)[0];\n      return {\n        scoresTensor: scoresTensor,\n        regionsTensor: regionsTensor,\n        scale: scale,\n        statsForScale: statsForScale\n      };\n    });\n  });\n  var boxesForScale = pnetOutputs.map(function (_a) {\n    var scoresTensor = _a.scoresTensor,\n        regionsTensor = _a.regionsTensor,\n        scale = _a.scale,\n        statsForScale = _a.statsForScale;\n    var boundingBoxes = extractBoundingBoxes(scoresTensor, regionsTensor, scale, scoreThreshold);\n    scoresTensor.dispose();\n    regionsTensor.dispose();\n\n    if (!boundingBoxes.length) {\n      stats.stage1.push(statsForScale);\n      return [];\n    }\n\n    var ts = Date.now();\n    var indices = nonMaxSuppression(boundingBoxes.map(function (bbox) {\n      return bbox.cell;\n    }), boundingBoxes.map(function (bbox) {\n      return bbox.score;\n    }), 0.5);\n    statsForScale.nms = Date.now() - ts;\n    statsForScale.numBoxes = indices.length;\n    stats.stage1.push(statsForScale);\n    return indices.map(function (boxIdx) {\n      return boundingBoxes[boxIdx];\n    });\n  });\n  var allBoxes = boxesForScale.reduce(function (all, boxes) {\n    return all.concat(boxes);\n  }, []);\n  var finalBoxes = [];\n  var finalScores = [];\n\n  if (allBoxes.length > 0) {\n    var ts = Date.now();\n    var indices = nonMaxSuppression(allBoxes.map(function (bbox) {\n      return bbox.cell;\n    }), allBoxes.map(function (bbox) {\n      return bbox.score;\n    }), 0.7);\n    stats.stage1_nms = Date.now() - ts;\n    finalScores = indices.map(function (idx) {\n      return allBoxes[idx].score;\n    });\n    finalBoxes = indices.map(function (idx) {\n      return allBoxes[idx];\n    }).map(function (_a) {\n      var cell = _a.cell,\n          region = _a.region;\n      return new BoundingBox(cell.left + region.left * cell.width, cell.top + region.top * cell.height, cell.right + region.right * cell.width, cell.bottom + region.bottom * cell.height).toSquare().round();\n    });\n  }\n\n  return {\n    boxes: finalBoxes,\n    scores: finalScores\n  };\n}","map":{"version":3,"mappings":"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","names":["tf","BoundingBox","Point","nonMaxSuppression","CELL_SIZE","CELL_STRIDE","getSizesForScale","MtcnnBox","normalize","PNet","rescaleAndNormalize","x","scale","tidy","height","width","resized","image","resizeBilinear","normalized","transpose","extractBoundingBoxes","scoresTensor","regionsTensor","scoreThreshold","indices","scoresData","arraySync","y","shape","push","boundingBoxes","map","cell","Math","round","idx","score","regionsData","region","stage1","imgTensor","scales","params","stats","pnetOutputs","statsForScale","ts","Date","now","prob","regions","pnet","unstack","boxesForScale","_a","dispose","length","nms","numBoxes","boxIdx","allBoxes","reduce","all","boxes","concat","finalBoxes","finalScores","stage1_nms","left","top","right","bottom","toSquare","scores"],"sources":["../../../src/mtcnn/stage1.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}