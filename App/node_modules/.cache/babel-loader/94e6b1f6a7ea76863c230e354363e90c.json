{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n/*\n    Helper Modules\n*/\n\nvar url_1 = __importStar(require(\"url\"));\n\nvar path_1 = __importDefault(require(\"path\"));\n\nvar crypto_1 = __importDefault(require(\"crypto\"));\n/*\n    Utils\n*/\n\n\nvar transformation_1 = __importDefault(require(\"../../utils/transformation\"));\n\nvar urlFormatter_1 = __importDefault(require(\"../../utils/urlFormatter\"));\n/*\n    Variables\n*/\n\n\nvar TRANSFORMATION_PARAMETER = \"tr\";\nvar SIGNATURE_PARAMETER = \"ik-s\";\nvar TIMESTAMP_PARAMETER = \"ik-t\";\nvar DEFAULT_TIMESTAMP = \"9999999999\";\n\nvar buildURL = function (opts) {\n  //Create correct query parameters\n  var parsedURL;\n  var parsedHost;\n  var isSrcParameterUsedForURL = false;\n  var urlObject = {\n    host: \"\",\n    pathname: \"\",\n    search: \"\"\n  };\n\n  if (opts.path) {\n    parsedURL = url_1.default.parse(opts.path);\n    parsedHost = url_1.default.parse(opts.urlEndpoint);\n    urlObject.protocol = parsedHost.protocol;\n    urlObject.host = opts.urlEndpoint.replace(urlObject.protocol + \"//\", \"\");\n  } else if (opts.src) {\n    parsedURL = url_1.default.parse(opts.src);\n    isSrcParameterUsedForURL = true;\n    urlObject.host = [parsedURL.auth, parsedURL.auth ? \"@\" : \"\", parsedURL.host].join(\"\");\n    urlObject.protocol = parsedURL.protocol;\n  } else {\n    return \"\";\n  }\n\n  urlObject.pathname = parsedURL.pathname ? parsedURL.pathname : \"\";\n  var queryParameters = new url_1.URLSearchParams(parsedURL.query || \"\");\n\n  for (var i in opts.queryParameters) {\n    queryParameters.set(i, opts.queryParameters[i]);\n  } //Create Transformation String\n\n\n  var transformationString = constructTransformationString(opts.transformation);\n\n  if (transformationString) {\n    //force that if src parameter is being used for URL construction then the transformation\n    //string should be added only as a query parameter\n    if (transformation_1.default.addAsQueryParameter(opts) || isSrcParameterUsedForURL) {\n      queryParameters.set(TRANSFORMATION_PARAMETER, transformationString);\n    } else {\n      urlObject.pathname = path_1.default.posix.join([TRANSFORMATION_PARAMETER, transformationString].join(transformation_1.default.getChainTransformDelimiter()), urlObject.pathname);\n    }\n  }\n\n  urlObject.host = urlFormatter_1.default.removeTrailingSlash(urlObject.host);\n  urlObject.pathname = urlFormatter_1.default.addLeadingSlash(urlObject.pathname);\n  urlObject.search = queryParameters.toString();\n  /*\n        Signature String and Timestamp\n        If the url is constructed using src parameter instead of path then we still replace the urlEndpoint we have\n        But the user is responsible for passing correct urlEndpoint value\n           Signature generation logic, let's assume:\n        urlEndpoint value = https://ik.imagekit.io/your_imagekit_id\n        expiryTimestamp 9999999999\n        1. Let the final URL construct e.g. https://ik.imagekit.io/your_imagekit_id/tr:w-400:rotate-91/sample/testing-file.jpg?param1=123\n        2. Now remove urlEndpoint from it i.e tr:w-400:rotate-91/sample/testing-file.jpg?param1=123\n        3. Append expiryTimestamp to above string and calcualte signature of this string i.e \"tr:w-400:rotate-91/sample/testing-file.jpg?param1=1239999999999\"\n    */\n\n  var expiryTimestamp;\n\n  if (opts.signed === true) {\n    if (opts.expireSeconds) {\n      expiryTimestamp = getSignatureTimestamp(opts.expireSeconds);\n    } else {\n      expiryTimestamp = DEFAULT_TIMESTAMP;\n    }\n\n    var intermediateURL = url_1.default.format(urlObject);\n    var urlSignature = getSignature({\n      privateKey: opts.privateKey,\n      url: intermediateURL,\n      urlEndpoint: opts.urlEndpoint,\n      expiryTimestamp: expiryTimestamp\n    });\n\n    if (expiryTimestamp && expiryTimestamp != DEFAULT_TIMESTAMP) {\n      queryParameters.set(TIMESTAMP_PARAMETER, expiryTimestamp);\n    }\n\n    queryParameters.set(SIGNATURE_PARAMETER, urlSignature);\n    urlObject.search = queryParameters.toString();\n  }\n\n  return url_1.default.format(urlObject);\n};\n\nfunction constructTransformationString(transformation) {\n  if (!Array.isArray(transformation)) {\n    return \"\";\n  }\n\n  var parsedTransforms = [];\n\n  for (var i = 0, l = transformation.length; i < l; i++) {\n    var parsedTransformStep = [];\n\n    for (var key in transformation[i]) {\n      var transformKey = transformation_1.default.getTransformKey(key);\n\n      if (!transformKey) {\n        transformKey = key;\n      }\n\n      if (transformation[i][key] === \"-\") {\n        parsedTransformStep.push(transformKey);\n      } else {\n        var value = String(transformation[i][key]);\n\n        if (transformKey === \"oi\" || transformKey === \"di\") {\n          value = urlFormatter_1.default.removeTrailingSlash(urlFormatter_1.default.removeLeadingSlash(value));\n          if (value) value = value.replace(/\\//g, \"@@\");\n        }\n\n        parsedTransformStep.push([transformKey, value].join(transformation_1.default.getTransformKeyValueDelimiter()));\n      }\n    }\n\n    parsedTransforms.push(parsedTransformStep.join(transformation_1.default.getTransformDelimiter()));\n  }\n\n  return parsedTransforms.join(transformation_1.default.getChainTransformDelimiter());\n}\n\nfunction getSignatureTimestamp(seconds) {\n  if (!seconds) return DEFAULT_TIMESTAMP;\n  var sec = parseInt(String(seconds), 10);\n  if (!sec) return DEFAULT_TIMESTAMP;\n  var currentTimestamp = parseInt(String(new Date().getTime() / 1000), 10);\n  return String(currentTimestamp + sec);\n}\n\nfunction getSignature(opts) {\n  if (!opts.privateKey || !opts.url || !opts.urlEndpoint) return \"\";\n  var stringToSign = opts.url.replace(urlFormatter_1.default.addTrailingSlash(opts.urlEndpoint), \"\") + opts.expiryTimestamp;\n  return crypto_1.default.createHmac(\"sha1\", opts.privateKey).update(stringToSign).digest(\"hex\");\n}\n\nexports.default = {\n  buildURL: buildURL,\n  getSignature: getSignature\n};","map":{"version":3,"sources":["/Users/akshitaanand/Documents/GitHub/emotion/App/node_modules/imagekit/dist/libs/url/builder.js"],"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__importStar","mod","__esModule","result","prototype","hasOwnProperty","call","__importDefault","exports","url_1","require","path_1","crypto_1","transformation_1","urlFormatter_1","TRANSFORMATION_PARAMETER","SIGNATURE_PARAMETER","TIMESTAMP_PARAMETER","DEFAULT_TIMESTAMP","buildURL","opts","parsedURL","parsedHost","isSrcParameterUsedForURL","urlObject","host","pathname","search","path","default","parse","urlEndpoint","protocol","replace","src","auth","join","queryParameters","URLSearchParams","query","i","set","transformationString","constructTransformationString","transformation","addAsQueryParameter","posix","getChainTransformDelimiter","removeTrailingSlash","addLeadingSlash","toString","expiryTimestamp","signed","expireSeconds","getSignatureTimestamp","intermediateURL","format","urlSignature","getSignature","privateKey","url","Array","isArray","parsedTransforms","l","length","parsedTransformStep","key","transformKey","getTransformKey","push","String","removeLeadingSlash","getTransformKeyValueDelimiter","getTransformDelimiter","seconds","sec","parseInt","currentTimestamp","Date","getTime","stringToSign","addTrailingSlash","createHmac","update","digest"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\n/*\n    Helper Modules\n*/\nvar url_1 = __importStar(require(\"url\"));\nvar path_1 = __importDefault(require(\"path\"));\nvar crypto_1 = __importDefault(require(\"crypto\"));\n/*\n    Utils\n*/\nvar transformation_1 = __importDefault(require(\"../../utils/transformation\"));\nvar urlFormatter_1 = __importDefault(require(\"../../utils/urlFormatter\"));\n/*\n    Variables\n*/\nvar TRANSFORMATION_PARAMETER = \"tr\";\nvar SIGNATURE_PARAMETER = \"ik-s\";\nvar TIMESTAMP_PARAMETER = \"ik-t\";\nvar DEFAULT_TIMESTAMP = \"9999999999\";\nvar buildURL = function (opts) {\n    //Create correct query parameters\n    var parsedURL;\n    var parsedHost;\n    var isSrcParameterUsedForURL = false;\n    var urlObject = { host: \"\", pathname: \"\", search: \"\" };\n    if (opts.path) {\n        parsedURL = url_1.default.parse(opts.path);\n        parsedHost = url_1.default.parse(opts.urlEndpoint);\n        urlObject.protocol = parsedHost.protocol;\n        urlObject.host = opts.urlEndpoint.replace(urlObject.protocol + \"//\", \"\");\n    }\n    else if (opts.src) {\n        parsedURL = url_1.default.parse(opts.src);\n        isSrcParameterUsedForURL = true;\n        urlObject.host = [parsedURL.auth, parsedURL.auth ? \"@\" : \"\", parsedURL.host].join(\"\");\n        urlObject.protocol = parsedURL.protocol;\n    }\n    else {\n        return \"\";\n    }\n    urlObject.pathname = parsedURL.pathname ? parsedURL.pathname : \"\";\n    var queryParameters = new url_1.URLSearchParams(parsedURL.query || \"\");\n    for (var i in opts.queryParameters) {\n        queryParameters.set(i, opts.queryParameters[i]);\n    }\n    //Create Transformation String\n    var transformationString = constructTransformationString(opts.transformation);\n    if (transformationString) {\n        //force that if src parameter is being used for URL construction then the transformation\n        //string should be added only as a query parameter\n        if (transformation_1.default.addAsQueryParameter(opts) || isSrcParameterUsedForURL) {\n            queryParameters.set(TRANSFORMATION_PARAMETER, transformationString);\n        }\n        else {\n            urlObject.pathname = path_1.default.posix.join([TRANSFORMATION_PARAMETER, transformationString].join(transformation_1.default.getChainTransformDelimiter()), urlObject.pathname);\n        }\n    }\n    urlObject.host = urlFormatter_1.default.removeTrailingSlash(urlObject.host);\n    urlObject.pathname = urlFormatter_1.default.addLeadingSlash(urlObject.pathname);\n    urlObject.search = queryParameters.toString();\n    /*\n          Signature String and Timestamp\n          If the url is constructed using src parameter instead of path then we still replace the urlEndpoint we have\n          But the user is responsible for passing correct urlEndpoint value\n  \n          Signature generation logic, let's assume:\n          urlEndpoint value = https://ik.imagekit.io/your_imagekit_id\n          expiryTimestamp 9999999999\n          1. Let the final URL construct e.g. https://ik.imagekit.io/your_imagekit_id/tr:w-400:rotate-91/sample/testing-file.jpg?param1=123\n          2. Now remove urlEndpoint from it i.e tr:w-400:rotate-91/sample/testing-file.jpg?param1=123\n          3. Append expiryTimestamp to above string and calcualte signature of this string i.e \"tr:w-400:rotate-91/sample/testing-file.jpg?param1=1239999999999\"\n      */\n    var expiryTimestamp;\n    if (opts.signed === true) {\n        if (opts.expireSeconds) {\n            expiryTimestamp = getSignatureTimestamp(opts.expireSeconds);\n        }\n        else {\n            expiryTimestamp = DEFAULT_TIMESTAMP;\n        }\n        var intermediateURL = url_1.default.format(urlObject);\n        var urlSignature = getSignature({\n            privateKey: opts.privateKey,\n            url: intermediateURL,\n            urlEndpoint: opts.urlEndpoint,\n            expiryTimestamp: expiryTimestamp,\n        });\n        if (expiryTimestamp && expiryTimestamp != DEFAULT_TIMESTAMP) {\n            queryParameters.set(TIMESTAMP_PARAMETER, expiryTimestamp);\n        }\n        queryParameters.set(SIGNATURE_PARAMETER, urlSignature);\n        urlObject.search = queryParameters.toString();\n    }\n    return url_1.default.format(urlObject);\n};\nfunction constructTransformationString(transformation) {\n    if (!Array.isArray(transformation)) {\n        return \"\";\n    }\n    var parsedTransforms = [];\n    for (var i = 0, l = transformation.length; i < l; i++) {\n        var parsedTransformStep = [];\n        for (var key in transformation[i]) {\n            var transformKey = transformation_1.default.getTransformKey(key);\n            if (!transformKey) {\n                transformKey = key;\n            }\n            if (transformation[i][key] === \"-\") {\n                parsedTransformStep.push(transformKey);\n            }\n            else {\n                var value = String(transformation[i][key]);\n                if (transformKey === \"oi\" || transformKey === \"di\") {\n                    value = urlFormatter_1.default.removeTrailingSlash(urlFormatter_1.default.removeLeadingSlash(value));\n                    if (value)\n                        value = value.replace(/\\//g, \"@@\");\n                }\n                parsedTransformStep.push([transformKey, value].join(transformation_1.default.getTransformKeyValueDelimiter()));\n            }\n        }\n        parsedTransforms.push(parsedTransformStep.join(transformation_1.default.getTransformDelimiter()));\n    }\n    return parsedTransforms.join(transformation_1.default.getChainTransformDelimiter());\n}\nfunction getSignatureTimestamp(seconds) {\n    if (!seconds)\n        return DEFAULT_TIMESTAMP;\n    var sec = parseInt(String(seconds), 10);\n    if (!sec)\n        return DEFAULT_TIMESTAMP;\n    var currentTimestamp = parseInt(String(new Date().getTime() / 1000), 10);\n    return String(currentTimestamp + sec);\n}\nfunction getSignature(opts) {\n    if (!opts.privateKey || !opts.url || !opts.urlEndpoint)\n        return \"\";\n    var stringToSign = opts.url.replace(urlFormatter_1.default.addTrailingSlash(opts.urlEndpoint), \"\") + opts.expiryTimestamp;\n    return crypto_1.default.createHmac(\"sha1\", opts.privateKey).update(stringToSign).digest(\"hex\");\n}\nexports.default = {\n    buildURL: buildURL,\n    getSignature: getSignature,\n};\n"]},"metadata":{},"sourceType":"script"}