{"ast":null,"code":"import * as tf from '@tensorflow/tfjs-core';\n\nfunction getCenterCoordinatesAndSizesLayer(x) {\n  var vec = tf.unstack(tf.transpose(x, [1, 0]));\n  var sizes = [tf.sub(vec[2], vec[0]), tf.sub(vec[3], vec[1])];\n  var centers = [tf.add(vec[0], tf.div(sizes[0], tf.scalar(2))), tf.add(vec[1], tf.div(sizes[1], tf.scalar(2)))];\n  return {\n    sizes: sizes,\n    centers: centers\n  };\n}\n\nfunction decodeBoxesLayer(x0, x1) {\n  var _a = getCenterCoordinatesAndSizesLayer(x0),\n      sizes = _a.sizes,\n      centers = _a.centers;\n\n  var vec = tf.unstack(tf.transpose(x1, [1, 0]));\n  var div0_out = tf.div(tf.mul(tf.exp(tf.div(vec[2], tf.scalar(5))), sizes[0]), tf.scalar(2));\n  var add0_out = tf.add(tf.mul(tf.div(vec[0], tf.scalar(10)), sizes[0]), centers[0]);\n  var div1_out = tf.div(tf.mul(tf.exp(tf.div(vec[3], tf.scalar(5))), sizes[1]), tf.scalar(2));\n  var add1_out = tf.add(tf.mul(tf.div(vec[1], tf.scalar(10)), sizes[1]), centers[1]);\n  return tf.transpose(tf.stack([tf.sub(add0_out, div0_out), tf.sub(add1_out, div1_out), tf.add(add0_out, div0_out), tf.add(add1_out, div1_out)]), [1, 0]);\n}\n\nexport function outputLayer(boxPredictions, classPredictions, params) {\n  return tf.tidy(function () {\n    var batchSize = boxPredictions.shape[0];\n    var boxes = decodeBoxesLayer(tf.reshape(tf.tile(params.extra_dim, [batchSize, 1, 1]), [-1, 4]), tf.reshape(boxPredictions, [-1, 4]));\n    boxes = tf.reshape(boxes, [batchSize, boxes.shape[0] / batchSize, 4]);\n    var scoresAndClasses = tf.sigmoid(tf.slice(classPredictions, [0, 0, 1], [-1, -1, -1]));\n    var scores = tf.slice(scoresAndClasses, [0, 0, 0], [-1, -1, 1]);\n    scores = tf.reshape(scores, [batchSize, scores.shape[1]]);\n    var boxesByBatch = tf.unstack(boxes);\n    var scoresByBatch = tf.unstack(scores);\n    return {\n      boxes: boxesByBatch,\n      scores: scoresByBatch\n    };\n  });\n}","map":{"version":3,"mappings":"AAAA,OAAO,KAAKA,EAAZ,MAAoB,uBAApB;;AAKA,SAASC,iCAAT,CAA2CC,CAA3C,EAAyD;AACvD,MAAMC,GAAG,GAAGH,EAAE,CAACI,OAAH,CAAWJ,EAAE,CAACK,SAAH,CAAaH,CAAb,EAAgB,CAAC,CAAD,EAAI,CAAJ,CAAhB,CAAX,CAAZ;AAEA,MAAMI,KAAK,GAAG,CACZN,EAAE,CAACO,GAAH,CAAOJ,GAAG,CAAC,CAAD,CAAV,EAAeA,GAAG,CAAC,CAAD,CAAlB,CADY,EAEZH,EAAE,CAACO,GAAH,CAAOJ,GAAG,CAAC,CAAD,CAAV,EAAeA,GAAG,CAAC,CAAD,CAAlB,CAFY,CAAd;AAKA,MAAMK,OAAO,GAAG,CACdR,EAAE,CAACS,GAAH,CAAON,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACU,GAAH,CAAOJ,KAAK,CAAC,CAAD,CAAZ,EAAiBN,EAAE,CAACW,MAAH,CAAU,CAAV,CAAjB,CAAf,CADc,EAEdX,EAAE,CAACS,GAAH,CAAON,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACU,GAAH,CAAOJ,KAAK,CAAC,CAAD,CAAZ,EAAiBN,EAAE,CAACW,MAAH,CAAU,CAAV,CAAjB,CAAf,CAFc,CAAhB;AAKA,SAAO;AACLL,SAAK,OADA;AAELE,WAAO;AAFF,GAAP;AAID;;AAED,SAASI,gBAAT,CAA0BC,EAA1B,EAA2CC,EAA3C,EAA0D;AAClD;AAAA,MACJR,gBADI;AAAA,MAEJE,oBAFI;;AAKN,MAAML,GAAG,GAAGH,EAAE,CAACI,OAAH,CAAWJ,EAAE,CAACK,SAAH,CAAaS,EAAb,EAAiB,CAAC,CAAD,EAAI,CAAJ,CAAjB,CAAX,CAAZ;AAEA,MAAMC,QAAQ,GAAGf,EAAE,CAACU,GAAH,CAAOV,EAAE,CAACgB,GAAH,CAAOhB,EAAE,CAACiB,GAAH,CAAOjB,EAAE,CAACU,GAAH,CAAOP,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACW,MAAH,CAAU,CAAV,CAAf,CAAP,CAAP,EAA6CL,KAAK,CAAC,CAAD,CAAlD,CAAP,EAA+DN,EAAE,CAACW,MAAH,CAAU,CAAV,CAA/D,CAAjB;AACA,MAAMO,QAAQ,GAAGlB,EAAE,CAACS,GAAH,CAAOT,EAAE,CAACgB,GAAH,CAAOhB,EAAE,CAACU,GAAH,CAAOP,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACW,MAAH,CAAU,EAAV,CAAf,CAAP,EAAsCL,KAAK,CAAC,CAAD,CAA3C,CAAP,EAAwDE,OAAO,CAAC,CAAD,CAA/D,CAAjB;AAEA,MAAMW,QAAQ,GAAGnB,EAAE,CAACU,GAAH,CAAOV,EAAE,CAACgB,GAAH,CAAOhB,EAAE,CAACiB,GAAH,CAAOjB,EAAE,CAACU,GAAH,CAAOP,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACW,MAAH,CAAU,CAAV,CAAf,CAAP,CAAP,EAA6CL,KAAK,CAAC,CAAD,CAAlD,CAAP,EAA+DN,EAAE,CAACW,MAAH,CAAU,CAAV,CAA/D,CAAjB;AACA,MAAMS,QAAQ,GAAGpB,EAAE,CAACS,GAAH,CAAOT,EAAE,CAACgB,GAAH,CAAOhB,EAAE,CAACU,GAAH,CAAOP,GAAG,CAAC,CAAD,CAAV,EAAeH,EAAE,CAACW,MAAH,CAAU,EAAV,CAAf,CAAP,EAAsCL,KAAK,CAAC,CAAD,CAA3C,CAAP,EAAwDE,OAAO,CAAC,CAAD,CAA/D,CAAjB;AAEA,SAAOR,EAAE,CAACK,SAAH,CACLL,EAAE,CAACqB,KAAH,CAAS,CACPrB,EAAE,CAACO,GAAH,CAAOW,QAAP,EAAiBH,QAAjB,CADO,EAEPf,EAAE,CAACO,GAAH,CAAOa,QAAP,EAAiBD,QAAjB,CAFO,EAGPnB,EAAE,CAACS,GAAH,CAAOS,QAAP,EAAiBH,QAAjB,CAHO,EAIPf,EAAE,CAACS,GAAH,CAAOW,QAAP,EAAiBD,QAAjB,CAJO,CAAT,CADK,EAOL,CAAC,CAAD,EAAI,CAAJ,CAPK,CAAP;AASD;;AAED,OAAM,SAAUG,WAAV,CACJC,cADI,EAEJC,gBAFI,EAGJC,MAHI,EAGqB;AAEzB,SAAOzB,EAAE,CAAC0B,IAAH,CAAQ;AAEb,QAAMC,SAAS,GAAGJ,cAAc,CAACK,KAAf,CAAqB,CAArB,CAAlB;AAEA,QAAIC,KAAK,GAAGjB,gBAAgB,CAC1BZ,EAAE,CAAC8B,OAAH,CAAW9B,EAAE,CAAC+B,IAAH,CAAQN,MAAM,CAACO,SAAf,EAA0B,CAACL,SAAD,EAAY,CAAZ,EAAe,CAAf,CAA1B,CAAX,EAAyD,CAAC,CAAC,CAAF,EAAK,CAAL,CAAzD,CAD0B,EAE1B3B,EAAE,CAAC8B,OAAH,CAAWP,cAAX,EAA2B,CAAC,CAAC,CAAF,EAAK,CAAL,CAA3B,CAF0B,CAA5B;AAIAM,SAAK,GAAG7B,EAAE,CAAC8B,OAAH,CACND,KADM,EAEN,CAACF,SAAD,EAAaE,KAAK,CAACD,KAAN,CAAY,CAAZ,IAAiBD,SAA9B,EAA0C,CAA1C,CAFM,CAAR;AAKA,QAAMM,gBAAgB,GAAGjC,EAAE,CAACkC,OAAH,CAAWlC,EAAE,CAACmC,KAAH,CAASX,gBAAT,EAA2B,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA3B,EAAsC,CAAC,CAAC,CAAF,EAAK,CAAC,CAAN,EAAS,CAAC,CAAV,CAAtC,CAAX,CAAzB;AACA,QAAIY,MAAM,GAAGpC,EAAE,CAACmC,KAAH,CAASF,gBAAT,EAA2B,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA3B,EAAsC,CAAC,CAAC,CAAF,EAAK,CAAC,CAAN,EAAS,CAAT,CAAtC,CAAb;AAEAG,UAAM,GAAGpC,EAAE,CAAC8B,OAAH,CACPM,MADO,EAEP,CAACT,SAAD,EAAYS,MAAM,CAACR,KAAP,CAAa,CAAb,CAAZ,CAFO,CAAT;AAKA,QAAMS,YAAY,GAAGrC,EAAE,CAACI,OAAH,CAAWyB,KAAX,CAArB;AACA,QAAMS,aAAa,GAAGtC,EAAE,CAACI,OAAH,CAAWgC,MAAX,CAAtB;AAEA,WAAO;AACLP,WAAK,EAAEQ,YADF;AAELD,YAAM,EAAEE;AAFH,KAAP;AAKD,GA7BM,CAAP;AA8BD","names":["tf","getCenterCoordinatesAndSizesLayer","x","vec","unstack","transpose","sizes","sub","centers","add","div","scalar","decodeBoxesLayer","x0","x1","div0_out","mul","exp","add0_out","div1_out","add1_out","stack","outputLayer","boxPredictions","classPredictions","params","tidy","batchSize","shape","boxes","reshape","tile","extra_dim","scoresAndClasses","sigmoid","slice","scores","boxesByBatch","scoresByBatch"],"sources":["../../../src/ssdMobilenetv1/outputLayer.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}